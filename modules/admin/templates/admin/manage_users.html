{% extends 'common/base.html' %}
{% load static %}

{% block title %}Manage Users - Admin Portal{% endblock %}

{% block sub_navbar %}
<nav class="navbar navbar-expand-lg navbar-dark sub-navbar">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'admin_module:dashboard' %}">Admin Portal</a>
        <div class="ms-auto">
            <span class="navbar-text me-3">Welcome, {{ user.username }}!</span>
            <a href="/auth/logout/" class="btn btn-sm btn-outline-light">Logout</a>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="content-box">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="content-box-title mb-0">Manage Users ({{ total_users }})</h3>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkActionModal">
                    <i class="bi bi-tools me-2"></i>Bulk Actions
                </button>
            </div>
        </div>
        

        
        {% if users %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Mobile</th>
                            <th>User Type</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_obj in users %}
                        <tr>
                            <td><input type="checkbox" class="user-checkbox" value="{{ user_obj.id }}"></td>
                            <td>{{ user_obj.id }}</td>
                            <td>{{ user_obj.first_name }} {{ user_obj.last_name }}</td>
                            <td>{{ user_obj.username }}</td>
                            <td>{{ user_obj.email|default:"-" }}</td>
                            <td>{{ user_obj.mobile_number|default:"-" }}</td>
                            <td>
                                {% if user_obj.user_type == 'admin' %}
                                    <span class="badge bg-danger">Admin</span>
                                {% elif user_obj.user_type == 'clerk' %}
                                    <span class="badge bg-primary">Clerk</span>
                                {% elif user_obj.user_type == 'citizen' %}
                                    <span class="badge bg-success">Citizen</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ user_obj.user_type|title }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user_obj.is_active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>{{ user_obj.created_at|date:"d M Y" }}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    {% if user_obj.is_active %}
                                        <button type="button" class="btn btn-outline-warning" title="Deactivate" onclick="confirmAction({{ user_obj.id }}, 'deactivate')">
                                            <i class="bi bi-pause"></i>
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-outline-success" title="Activate" onclick="confirmAction({{ user_obj.id }}, 'activate')">
                                            <i class="bi bi-play"></i>
                                        </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-danger" title="Delete" onclick="confirmAction({{ user_obj.id }}, 'delete')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <p class="text-muted mb-0">Showing {{ users|length }} of {{ total_users }} users</p>
                </div>
                <div>
                    <!-- Add pagination controls here if needed -->
                </div>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-people display-1 text-muted"></i>
                <h4 class="mt-3">No Users Found</h4>
                <p class="text-muted">No user accounts have been created yet.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Bulk Action Modal -->
<div class="modal fade" id="bulkActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Bulk User Actions</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkActionForm">
                    <div class="mb-3">
                        <label class="form-label">Select Action:</label>
                        <select class="form-select" id="bulkActionSelect">
                            <option value="">-- Select Action --</option>
                            <option value="activate">Activate Selected Users</option>
                            <option value="deactivate">Deactivate Selected Users</option>
                            <option value="delete">Delete Selected Users</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <p id="selectedUsersCount">Selected Users: 0</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performBulkAction()">Apply Action</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Select all checkboxes
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.user-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });

    // Update selected count when individual checkbox changes
    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.user-checkbox:checked').length;
        document.getElementById('selectedUsersCount').textContent = `Selected Users: ${selectedCount}`;
    }

    function confirmAction(userId, action) {
        let actionText = '';
        if (action === 'activate') {
            actionText = 'activate this user';
        } else if (action === 'deactivate') {
            actionText = 'deactivate this user';
        } else if (action === 'delete') {
            actionText = 'delete this user';
        }

        if (confirm(`Are you sure you want to ${actionText}?`)) {
            // In a real implementation, this would submit a form or make an AJAX request
            alert(`Action '${action}' would be performed on user ID: ${userId}`);
        }
    }

    function performBulkAction() {
        const action = document.getElementById('bulkActionSelect').value;
        if (!action) {
            alert('Please select an action');
            return;
        }

        const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked'))
                                  .map(checkbox => checkbox.value);

        if (selectedUsers.length === 0) {
            alert('Please select at least one user');
            return;
        }

        let actionText = '';
        if (action === 'activate') {
            actionText = 'activate';
        } else if (action === 'deactivate') {
            actionText = 'deactivate';
        } else if (action === 'delete') {
            actionText = 'delete';
        }

        if (confirm(`Are you sure you want to ${actionText} ${selectedUsers.length} selected users?`)) {
            // In a real implementation, this would submit a form or make an AJAX request
            alert(`Bulk action '${action}' would be performed on ${selectedUsers.length} users`);
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('bulkActionModal')).hide();
        }
    }
</script>
{% endblock %}