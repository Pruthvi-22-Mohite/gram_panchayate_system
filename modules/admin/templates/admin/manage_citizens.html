{% extends 'common/base.html' %}
{% load static %}

{% block title %}Manage Citizens - Admin Portal{% endblock %}

{% block sub_navbar %}
<nav class="navbar navbar-expand-lg navbar-dark sub-navbar">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'admin_module:dashboard' %}">Admin Portal</a>
        <div class="ms-auto">
            <span class="navbar-text me-3">Welcome, {{ user.username }}!</span>
            <a href="/auth/logout/" class="btn btn-sm btn-outline-light">Logout</a>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="content-box">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="content-box-title mb-0">Manage Citizens ({{ total_citizens }})</h3>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkActionModal">
                    <i class="bi bi-tools me-2"></i>Bulk Actions
                </button>
                <a href="{% url 'admin_module:dashboard' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Admin Dashboard
                </a>
            </div>
        </div>
        

        
        {% if citizens %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Citizen ID</th>
                            <th>Name</th>
                            <th>Mobile Number</th>
                            <th>Aadhaar Number</th>
                            <th>Status</th>
                            <th>Registered</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for citizen in citizens %}
                        <tr>
                            <td><input type="checkbox" class="citizen-checkbox" value="{{ citizen.user.id }}"></td>
                            <td>{{ citizen.user.id }}</td>
                            <td>{% if citizen.user.first_name and citizen.user.last_name %}{{ citizen.user.first_name }} {{ citizen.user.last_name }}{% elif citizen.user.first_name %}{{ citizen.user.first_name }}{% elif citizen.user.last_name %}{{ citizen.user.last_name }}{% else %}{{ citizen.user.username }}{% endif %}</td>
                            <td>{{ citizen.user.mobile_number }}</td>
                            <td>{{ citizen.aadhaar_number|default:"-" }}</td>
                            <td>
                                {% if citizen.user.is_active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>{{ citizen.user.created_at|date:"d M Y" }}</td>
                            <td>
                                {% if citizen.user.last_login %}
                                    {{ citizen.user.last_login|date:"d M Y" }}
                                {% else %}
                                    <span class="text-muted">Never</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'admin_module:view_citizen_details' citizen.user.id %}" class="btn btn-outline-primary" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if citizen.user.is_active %}
                                        <a href="{% url 'admin_module:toggle_citizen_status' citizen.user.id %}" class="btn btn-outline-warning" title="Deactivate">
                                            <i class="bi bi-pause"></i>
                                        </a>
                                    {% else %}
                                        <a href="{% url 'admin_module:toggle_citizen_status' citizen.user.id %}" class="btn btn-outline-success" title="Activate">
                                            <i class="bi bi-play"></i>
                                        </a>
                                    {% endif %}
                                    <a href="{% url 'admin_module:delete_citizen' citizen.user.id %}" class="btn btn-outline-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this citizen? This action cannot be undone.')">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <p class="text-muted mb-0">Showing {{ citizens|length }} of {{ total_citizens }} citizens</p>
                </div>
                <div>
                    <!-- Add pagination controls here if needed -->
                </div>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-people display-1 text-muted"></i>
                <h4 class="mt-3">No Citizens Found</h4>
                <p class="text-muted">No citizen accounts have been registered yet.</p>
            </div>
        {% endif %}
    </div>
</div>

{% csrf_token %}
<!-- Bulk Action Modal -->
<div class="modal fade" id="bulkActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Bulk Citizen Actions</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkActionForm">
                    <div class="mb-3">
                        <label class="form-label">Select Action:</label>
                        <select class="form-select" id="bulkActionSelect">
                            <option value="">-- Select Action --</option>
                            <option value="activate">Activate Selected Citizens</option>
                            <option value="deactivate">Deactivate Selected Citizens</option>
                            <option value="delete">Delete Selected Citizens</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <p id="selectedCitizensCount">Selected Citizens: 0</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performBulkAction()">Apply Action</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Select all checkboxes
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.citizen-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });

    // Update selected count when individual checkbox changes
    document.querySelectorAll('.citizen-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.citizen-checkbox:checked').length;
        document.getElementById('selectedCitizensCount').textContent = `Selected Citizens: ${selectedCount}`;
    }

    async function performBulkAction() {
        const action = document.getElementById('bulkActionSelect').value;
        if (!action) {
            Swal.fire({
                icon: 'warning',
                title: 'No Action Selected',
                text: 'Please select an action',
                confirmButtonClass: 'btn btn-primary'
            });
            return;
        }

        const selectedCitizens = Array.from(document.querySelectorAll('.citizen-checkbox:checked'))
                                   .map(checkbox => parseInt(checkbox.value));

        if (selectedCitizens.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'No Citizens Selected',
                text: 'Please select at least one citizen',
                confirmButtonClass: 'btn btn-primary'
            });
            return;
        }

        let actionText = '';
        let actionTitle = '';
        if (action === 'activate') {
            actionText = 'activate';
            actionTitle = 'Activate';
        } else if (action === 'deactivate') {
            actionText = 'deactivate';
            actionTitle = 'Deactivate';
        } else if (action === 'delete') {
            actionText = 'delete';
            actionTitle = 'Delete';
        }

        const result = await Swal.fire({
            title: `Confirm ${actionTitle} Action`,
            text: `Are you sure you want to ${actionText} ${selectedCitizens.length} selected citizens?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: `Yes, ${actionText} them!`,
            cancelButtonText: 'Cancel',
            confirmButtonClass: 'btn btn-primary',
            cancelButtonClass: 'btn btn-secondary'
        });

        if (result.isConfirmed) {
            // Show loading indicator
            Swal.fire({
                title: 'Processing...',
                text: `Performing ${actionText} action on selected citizens...`,
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('{% url "admin_module:bulk_citizen_actions" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        action: action,
                        citizen_ids: selectedCitizens
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: data.message,
                        confirmButtonClass: 'btn btn-success'
                    }).then(() => {
                        // Refresh the page to update the table
                        location.reload();
                    });
                } else {
                    // Error message
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.message,
                        confirmButtonClass: 'btn btn-danger'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An unexpected error occurred while processing the bulk action.',
                    confirmButtonClass: 'btn btn-danger'
                });
            }
        }
    }
</script>
{% endblock %}